{% extends "base.html" %}

{% block title %}Shop - Case Clicker{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">

<h1>CS2 Case Shop</h1>

<!-- Add the floating notification element -->
<div id="floating-notification" class="floating-notification"></div>

<!-- Add the case opening overlay -->
<div id="case-opening-overlay" class="hidden">
    <audio id="spinning-sound" preload="auto">
        <source src="{{ url_for('static', filename='media/case_spinning.mp3') }}" type="audio/mpeg">
    </audio>
    <div class="spinner-container">
        <div class="spinner">
            <!-- Items will be inserted here dynamically -->
        </div>
        <div class="spinner-selector"></div>
    </div>
</div>

<!-- Add this right after the case-opening-overlay div -->
<div id="case-contents-overlay" class="case-contents-overlay" style="display: none;">
    <div class="case-contents-container">
        <div class="case-contents-header">
            <div class="case-info">
                <h2 class="case-name"></h2>
                <div class="stattrak-info">StatTrak™ (10% Chance)</div>
            </div>
            <button class="showcase-close" onclick="closeContentsOverlay()">×</button>
        </div>
        <div class="case-contents-list">
            <div class="content-row rarity-CONTRABAND">
                <div class="rarity-header">
                    <span class="rarity-name">Contraband Weapons</span>
                    <span class="drop-chance">(0.026%)</span>
                </div>
                <div class="items-grid"></div>
            </div>
            <div class="content-row rarity-GOLD">
                <div class="rarity-header">
                    <span class="rarity-name">★ Rare Special Item (Patterns available)</span>
                    <span class="drop-chance">(0.26%)</span>
                </div>
                <div class="items-grid"></div>
            </div>
            <div class="content-row rarity-RED">
                <div class="rarity-header">
                    <span class="rarity-name">Covert Weapons</span>
                    <span class="drop-chance">(0.90%)</span>
                </div>
                <div class="items-grid"></div>
            </div>
            <div class="content-row rarity-PINK">
                <div class="rarity-header">
                    <span class="rarity-name">Classified Weapons</span>
                    <span class="drop-chance">(4.10%)</span>
                </div>
                <div class="items-grid"></div>
            </div>
            <div class="content-row rarity-PURPLE">
                <div class="rarity-header">
                    <span class="rarity-name">Restricted Weapons</span>
                    <span class="drop-chance">(20.08%)</span>
                </div>
                <div class="items-grid"></div>
            </div>
            <div class="content-row rarity-BLUE">
                <div class="rarity-header">
                    <span class="rarity-name">Mil-Spec Weapons</span>
                    <span class="drop-chance">(74.66%)</span>
                </div>
                <div class="items-grid"></div>
            </div>
        </div>
    </div>
</div>

<!-- New shop layout with categories -->
<div class="shop-container">
    <!-- Category navigation -->
    <div class="shop-categories">
        <button class="category-btn active" data-category="cases">Cases</button>
        <button class="category-btn" data-category="skins">Skins</button>
        <button class="category-btn" data-category="stickers">Sticker Capsules</button>
        <button class="category-btn" data-category="collections">Collections</button>
        <button class="category-btn" data-category="souvenir">Souvenir Packages</button>
    </div>

    <!-- Cases Section -->
    <div class="shop-section" id="cases-section">
        <h2>Cases</h2>
        <div class="items-grid">
            {% for case_type, case_data in cases.items() %}
            <div class="shop-item">
                <img src="{{ url_for('static', filename='media/cases/' + case_data.image) }}" 
                     alt="{{ case_data.name }}" 
                     onclick="showCaseContents('{{ case_type }}')"
                     loading="lazy">
                <div class="item-details">
                    <h3>{{ case_data.name }}</h3>
                    <p class="price">${{ "%.2f"|format(case_data.price) }}</p>
                    <div class="buy-controls">
                        <input type="number" min="1" value="1" class="quantity-input" id="{{ case_type }}-quantity">
                        <button class="btn-small" onclick="buyCase('{{ case_type }}')">Buy</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Skins Section -->
    <div class="shop-section hidden" id="skins-section">
        <h2>Featured Skins | <span class="refresh-text">Refreshes in: <span class="countdown"></span></span></h2>
        <div class="featured-skins">
            <div class="skin-card rarity-GOLD">
                <div class="skin-image"></div>
                <div class="skin-info">
                    <div class="skin-name"></div>
                    <div class="skin-wear"></div>
                    <div class="skin-float"></div>
                    <div class="skin-price"></div>
                    <button class="buy-skin-btn">Purchase</button>
                </div>
            </div>
            <div class="skin-card rarity-RED">
                <div class="skin-image"></div>
                <div class="skin-info">
                    <div class="skin-name"></div>
                    <div class="skin-wear"></div>
                    <div class="skin-float"></div>
                    <div class="skin-price"></div>
                    <button class="buy-skin-btn">Purchase</button>
                </div>
            </div>
            <div class="skin-card rarity-PINK">
                <div class="skin-image"></div>
                <div class="skin-info">
                    <div class="skin-name"></div>
                    <div class="skin-wear"></div>
                    <div class="skin-float"></div>
                    <div class="skin-price"></div>
                    <button class="buy-skin-btn">Purchase</button>
                </div>
            </div>
            <div class="skin-card rarity-PURPLE">
                <div class="skin-image"></div>
                <div class="skin-info">
                    <div class="skin-name"></div>
                    <div class="skin-wear"></div>
                    <div class="skin-float"></div>
                    <div class="skin-price"></div>
                    <button class="buy-skin-btn">Purchase</button>
                </div>
            </div>
            <div class="skin-card rarity-BLUE">
                <div class="skin-image"></div>
                <div class="skin-info">
                    <div class="skin-name"></div>
                    <div class="skin-wear"></div>
                    <div class="skin-float"></div>
                    <div class="skin-price"></div>
                    <button class="buy-skin-btn">Purchase</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let caseContents = {};
    let validWears = {};
    let featuredSkins = JSON.parse(localStorage.getItem('featuredSkins')) || null;
    let lastRefreshTime = parseInt(localStorage.getItem('lastRefreshTime')) || null;
    const REFRESH_INTERVAL = 3600000; // 1 hour in milliseconds

    // Add this function to load case contents
    async function loadCaseContents(caseType) {
        try {
            const response = await fetch(`/data/case_contents/${caseType}`);
            const data = await response.json();
            if (data.error) {
                console.error('Error loading case contents:', data.error);
                return null;
            }
            return data;
        } catch (error) {
            console.error('Error loading case contents:', error);
            return null;
        }
    }

    // Load case contents when page loads
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize the category buttons
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                button.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('.shop-section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show selected section
                const category = button.dataset.category;
                const section = document.getElementById(`${category}-section`);
                if (section) {
                    section.classList.remove('hidden');
                }
            });
        });

        // Initial load if we start on skins tab
        if (document.querySelector('[data-category="skins"]').classList.contains('active')) {
            await loadFeaturedSkins();
            updateFeaturedSkins();
        }
    });

    function generateRandomItems(actualItem) {
        const itemPools = {
            BLUE: caseContents[actualItem.case_type].contents.BLUE,
            PURPLE: caseContents[actualItem.case_type].contents.PURPLE,
            PINK: caseContents[actualItem.case_type].contents.PINK,
            RED: caseContents[actualItem.case_type].contents.RED,
            GOLD: caseContents[actualItem.case_type].contents.GOLD
        };

        function randomFromPool(rarity, retryCount = 0) {
            // Add retry limit to prevent infinite recursion
            if (retryCount > 10) {
                console.error('Max retry count reached, defaulting to basic item');
                return {
                    weapon: "AK-47",
                    name: "Case Hardened",
                    rarity: "PINK",
                    stattrak: false,
                    wear: "FT",
                    price: 211.26,
                    case_type: actualItem.case_type
                };
            }

            const pool = itemPools[rarity];
            const item = {...pool[Math.floor(Math.random() * pool.length)]};
            const hasStattrak = Math.random() < 0.1;
            
            // Special handling for gold items (knives)
            if (rarity === 'GOLD') {
                // Get valid wears for this skin
                const skinKey = `${item.weapon}|${item.name}`;
                const availableWears = validWears[skinKey];
                
                if (!availableWears || availableWears.length === 0) {
                    console.warn(`No valid wears found for ${skinKey}, trying again...`);
                    return randomFromPool(rarity, retryCount + 1);
                }
                
                // Choose from valid wear values only
                const wear = availableWears[Math.floor(Math.random() * availableWears.length)];
                
                // Get price from skinPrices
                const priceKey = skinKey;
                const prices = skinPrices[priceKey] || {};
                const priceIndex = hasStattrak ? `ST_${wear}` : wear;
                const price = prices[priceIndex] || prices[wear] || 0;
                
                return {
                    weapon: item.weapon,
                    name: item.name,
                    rarity: rarity,
                    stattrak: hasStattrak,
                    wear: wear,
                    price: price,
                    case_type: actualItem.case_type
                };
            }
            
            // Normal skin handling
            const skinKey = `${item.weapon}|${item.name}`;
            const availableWears = validWears[skinKey] || ["FT"];
            const wear = availableWears[Math.floor(Math.random() * availableWears.length)];
            
            const prices = skinPrices[skinKey] || {};
            const priceIndex = hasStattrak ? `ST_${wear}` : wear;
            const price = prices[priceIndex] || prices[wear] || 0;
            
            return {
                ...item,
                stattrak: hasStattrak,
                wear: wear,
                price: price,
                case_type: actualItem.case_type
            };
        }

        function generateRandomItem() {
            // Roll for rarity
            const roll = Math.random() * 100;
            let chosenRarity;
            
            if (roll < 0.26) {
                chosenRarity = "GOLD";
            } else if (roll < 0.26 + 0.90) {
                chosenRarity = "RED";
            } else if (roll < 0.26 + 0.90 + 4.10) {
                chosenRarity = "PINK";
            } else if (roll < 0.26 + 0.90 + 4.10 + 20.08) {
                chosenRarity = "PURPLE";
            } else {
                chosenRarity = "BLUE";
            }

            return randomFromPool(chosenRarity);
        }

        const items = [];
        const totalItems = 100;
        const winningPosition = 85;
        
        // Generate random items for the wheel
        for (let i = 0; i < totalItems; i++) {
            if (i === winningPosition) {
                // Place the actual item from the server exactly at the winning position
                items.push({
                    weapon: actualItem.weapon,
                    name: actualItem.name,
                    rarity: actualItem.rarity,
                    wear: actualItem.wear,
                    stattrak: actualItem.stattrak,
                    price: actualItem.price
                });
            } else {
                // Generate a random item based on rarity percentages
                items.push(generateRandomItem());
            }
        }
        
        return { items, winningPosition };
    }

    function createItemElement(item, caseType) {
        const div = document.createElement('div');
        div.className = 'case-item';
        
        const folder = CASE_MAPPING[caseType] || caseType;
        
        // Use the image name directly from the JSON data
        const imgPath = `/static/media/skins/${folder}/${item.image}`;
        
        div.innerHTML = `
            <img src="${imgPath}" 
                 alt="${item.weapon} | ${item.name}" 
                 loading="lazy"
                 onerror="this.src='/static/media/cases/${folder}.png'">
            <div class="item-name">${item.weapon} | ${item.name}</div>
        `;
        
        return div;
    }

    function showItemShowcase(item) {
        const showcase = document.getElementById('showcase-overlay');
        const showcaseSound = document.getElementById('showcase-sound');
        const showcaseContainer = showcase.querySelector('.showcase-container');
        
        // Clear any existing buttons container
        const existingButtons = showcaseContainer.querySelector('.showcase-buttons');
        if (existingButtons) {
            existingButtons.remove();
        }
        
        // Rest of the showcase update code...
        const nameElement = showcase.querySelector('.showcase-name');
        const detailsElement = showcase.querySelector('.showcase-details');
        const priceElement = showcase.querySelector('.showcase-price');
        
        // Remove any existing rarity classes
        showcaseContainer.className = 'showcase-container';
        // Add the new rarity class
        showcaseContainer.classList.add(`rarity-${item.rarity}`);
        
        // Create image element
        const imageElement = document.createElement('img');
        if (item.rarity === 'GOLD') {
            // For knives, use the exact image name from the case data
            const casePath = item.case_type === 'bravo' ? 'operation_bravo_case' : 
                            item.case_type === 'esports' ? 'esports_2013' : 
                            item.case_type === 'winter_offensive' ? 'winter_offensive_case' : 'weapon_case_1';
            
            // Load case data to get the correct image name
            const caseData = caseContents[item.case_type];
            if (caseData) {
                const knifeData = caseData.skins.gold.find(
                    knife => knife.weapon === item.weapon && knife.name === item.name
                );
                if (knifeData && knifeData.image) {
                    imageElement.src = `/static/media/skins/${casePath}/${knifeData.image}`;
                } else {
                    // Fallback if image not found in case data
                    const weaponName = item.weapon.replace('★ ', '')
                        .toLowerCase()
                        .replace(' knife', 'knife');
                    const skinName = item.name.toLowerCase().replace(/\s+/g, '_');
                    imageElement.src = `/static/media/skins/${casePath}/${weaponName}_${skinName}.png`;
                }
            }
        } else {
            // For regular skins, construct the image path
            const weaponName = item.weapon.toLowerCase()
                .replace('-', '')
                .replace(' ', '')
                .replace('553', '553');
            const skinName = item.name.toLowerCase().replace(' ', '_');
            // Update case path to use _case suffix for images
            const casePath = item.case_type === 'bravo' ? 'operation_bravo_case' : 
                            item.case_type === 'esports' ? 'esports_2013' : 'weapon_case_1';
            imageElement.src = `/static/media/skins/${casePath}/${weaponName}_${skinName}.png`;
        }
        
        imageElement.style.maxWidth = '300px';
        imageElement.style.marginBottom = '1rem';
        
        // Update showcase content
        const itemContainer = showcase.querySelector('.showcase-item');
        itemContainer.innerHTML = ''; // Clear existing content
        itemContainer.appendChild(imageElement);
        
        // Set item details
        nameElement.className = `showcase-name ${item.stattrak ? 'stattrak' : ''}`;
        nameElement.textContent = `${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon} | ${item.name}`;
        
        itemContainer.appendChild(nameElement);
        
        detailsElement.textContent = `${item.wear} • ${item.rarity === 'GOLD' ? 'Rare Special Item' : item.rarity}`;
        itemContainer.appendChild(detailsElement);
        
        priceElement.textContent = `$${item.price.toFixed(2)}`;
        itemContainer.appendChild(priceElement);
        
        // Create new buttons container
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'showcase-buttons';
        
        const continueButton = document.createElement('button');
        continueButton.className = 'showcase-continue';
        continueButton.textContent = 'Continue';
        
        const sellButton = document.createElement('button');
        sellButton.className = 'showcase-sell';
        sellButton.textContent = 'Sell';
        
        buttonsContainer.appendChild(continueButton);
        buttonsContainer.appendChild(sellButton);
        
        // Add the buttons container to the showcase container
        showcaseContainer.appendChild(buttonsContainer);
        
        // Add button handlers
        continueButton.onclick = async () => {
            showcase.style.display = 'none';
            showcaseSound.pause();
            
            // Fetch updated user data after case opening
            try {
                const response = await fetch('/get_user_data');
                const userData = await response.json();
                
                // Update rank and exp display
                const rankInfo = document.querySelector('.current-rank');
                const expInfo = document.querySelector('.exp-info');
                const progressFill = document.querySelector('.progress-fill');
                
                if (rankInfo && expInfo && progressFill) {
                    rankInfo.textContent = userData.rankName;
                    
                    if (userData.nextRankExp) {
                        expInfo.textContent = `${userData.exp}/${userData.nextRankExp} EXP`;
                        const progressPercentage = (userData.exp / userData.nextRankExp) * 100;
                        progressFill.style.width = `${progressPercentage}%`;
                    } else {
                        expInfo.textContent = 'MAX RANK';
                        progressFill.style.width = '100%';
                    }
                }
            } catch (error) {
                console.error('Error updating user data:', error);
            }
            
            // Navigate to inventory and update display
            const inventorySection = document.getElementById('inventory-items');
            if (inventorySection) {
                // We're already on the inventory page, just update it
                await updateInventoryDisplay();
            } else {
                // Store the new item in session storage before navigating
                sessionStorage.setItem('newItem', JSON.stringify(item));
                // Navigate to inventory page
                window.location.href = '/inventory?view=skins';
            }
        };
        
        sellButton.onclick = async () => {
            try {
                const response = await fetch('/sell/last', { method: 'POST' });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Update balance
                document.getElementById('balance').textContent = data.balance.toFixed(2);
                
                // Close showcase
                showcase.style.display = 'none';
                showcaseSound.pause();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to sell item');
            }
        };
        
        // Show overlay and play sound
        showcase.style.display = 'flex';
        showcaseSound.currentTime = 0;
        showcaseSound.play();
    }

    async function openCase(caseType) {
        const response = await fetch(`/open/${caseType}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }

        // Update balance
        document.getElementById('balance').textContent = data.balance.toFixed(2);

        // Update rank and exp immediately after case opens
        const rankInfo = document.querySelector('.current-rank');
        const expInfo = document.querySelector('.exp-info');
        const progressFill = document.querySelector('.progress-fill');
        
        if (rankInfo && expInfo && progressFill) {
            rankInfo.textContent = data.rankName;
            
            if (data.nextRankExp) {
                expInfo.textContent = `${data.exp}/${data.nextRankExp} EXP`;
                const progressPercentage = (data.exp / data.nextRankExp) * 100;
                progressFill.style.width = `${progressPercentage}%`;
            } else {
                expInfo.textContent = 'MAX RANK';
                progressFill.style.width = '100%';
            }
        }

        alert(`You unboxed: ${data.item.stattrak ? 'StatTrak™ ' : ''}${data.item.weapon} | ${data.item.name} (${data.item.wear.replace('_', ' ')})`);
    }

    // Add category switching functionality
    document.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            button.classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.shop-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            const category = button.dataset.category;
            document.getElementById(`${category}-section`).classList.remove('hidden');
        });
    });

    async function buyCase(caseType) {
        const quantity = document.getElementById(`${caseType}-quantity`).value;
        try {
            const response = await fetch('/buy_case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    case_type: caseType,
                    quantity: parseInt(quantity)
                })
            });
            const data = await response.json();
            
            if (data.error) {
                showFloatingNotification(data.error);
                return;
            }
            
            // Update balance
            document.getElementById('balance').textContent = data.balance.toFixed(2);
            showFloatingNotification(`Purchased ${quantity} ${caseType.toUpperCase()} case(s)!`);
            
        } catch (error) {
            console.error('Error:', error);
            showFloatingNotification('Failed to purchase cases');
        }
    }

    // Replace the existing showFloatingNotification function
    let notificationTimeout;
    let currentNotification = {
        caseType: null,
        count: 0
    };

    function showFloatingNotification(message) {
        const notification = document.getElementById('floating-notification');
        
        // Check if this is a case purchase notification
        const purchaseMatch = message.match(/Purchased (\d+) (\w+) case/i);
        
        if (purchaseMatch) {
            const [_, quantity, caseType] = purchaseMatch;
            
            // If we have an active notification for the same case type
            if (currentNotification.caseType === caseType && notification.classList.contains('show')) {
                // Increment the count
                currentNotification.count += parseInt(quantity);
                // Update the message
                notification.textContent = `Purchased ${currentNotification.count} ${caseType} case${currentNotification.count > 1 ? 's' : ''}!`;
                
                // Reset the animation
                notification.style.animation = 'none';
                notification.offsetHeight; // Trigger reflow
                notification.style.animation = 'floatAndFade 2s ease-out forwards';
                
                // Clear existing timeout
                if (notificationTimeout) {
                    clearTimeout(notificationTimeout);
                }
            } else {
                // New case type or no active notification
                currentNotification.caseType = caseType;
                currentNotification.count = parseInt(quantity);
                
                if (!notification.classList.contains('show')) {
                    notification.classList.add('show');
                }
                notification.textContent = message;
                
                // Reset animation
                notification.style.animation = 'none';
                notification.offsetHeight; // Trigger reflow
                notification.style.animation = 'floatAndFade 2s ease-out forwards';
            }
        } else {
            // Non-case purchase notification
            currentNotification.caseType = null;
            currentNotification.count = 0;
            
            if (!notification.classList.contains('show')) {
                notification.classList.add('show');
            }
            notification.textContent = message;
            
            // Reset animation
            notification.style.animation = 'none';
            notification.offsetHeight; // Trigger reflow
            notification.style.animation = 'floatAndFade 2s ease-out forwards';
        }
        
        // Set new timeout
        notificationTimeout = setTimeout(() => {
            notification.classList.remove('show');
            currentNotification.caseType = null;
            currentNotification.count = 0;
        }, 2000);
    }

    // Add this new function to fetch and update inventory
    async function updateInventoryDisplay() {
        try {
            const response = await fetch('/get_inventory');
            const data = await response.json();
            
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            const inventoryItems = document.getElementById('inventory-items');
            if (!inventoryItems) return;
            
            // Clear current inventory
            inventoryItems.innerHTML = '';
            
            // Add each item
            data.inventory.forEach((item, index) => {
                if (!item.is_case) {  // Only show skins, not cases
                    const skinDiv = document.createElement('div');
                    skinDiv.className = `skin rarity-${item.rarity}`;
                    skinDiv.dataset.index = index;
                    
                    const weaponName = item.weapon.toLowerCase()
                        .replace('-', '')
                        .replace(' ', '')
                        .replace('553', '553');
                    const skinName = item.name.toLowerCase().replace(' ', '_');
                    
                    if (item.rarity === 'CONTRABAND') {
                        div.innerHTML = `
                            <div class="spinner-item-image">
                                <img src="/static/media/skins/${casePath}/${weaponName}_${skinName}.png" 
                                     alt="${item.weapon} | ${item.name}">
                            </div>
                            <div class="item-name ${item.stattrak ? 'stattrak' : ''}">
                                ${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon}
                            </div>
                            <div class="item-skin">
                                ${item.name} (Contraband)
                            </div>
                        `;
                    } else {
                        div.innerHTML = `
                            <div class="skin-image">
                                ${!item.weapon.startsWith('★') ? `
                                    <img src="/static/media/skins/weapon_case_1/${weaponName}_${skinName}.png" 
                                         alt="${item.weapon} | ${item.name}">
                                ` : ''}
                            </div>
                            <div class="item-name ${item.stattrak ? 'stattrak' : ''}">
                                ${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon}
                            </div>
                            <div class="item-skin">
                                ${item.name} (${item.wear})
                            </div>
                            <div class="item-price">$${item.price.toFixed(2)}</div>
                            <button class="btn sell-btn" data-sell-index="${index}">Sell</button>
                        `;
                    }
                    
                    // Add sell button handler
                    const sellBtn = skinDiv.querySelector('.sell-btn');
                    sellBtn.addEventListener('click', function() {
                        sellItem(this.dataset.sellIndex);
                    });
                    
                    inventoryItems.appendChild(skinDiv);
                }
            });
            
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function showCaseContents(caseType) {
        // Load case contents if not already loaded
        if (!caseContents[caseType]) {
            caseContents[caseType] = await loadCaseContents(caseType);
            if (!caseContents[caseType]) {
                alert('Failed to load case contents');
                return;
            }
        }

        const data = caseContents[caseType];
        const overlay = document.getElementById('case-contents-overlay');
        
        if (overlay) {
            // Update case name
            const caseName = overlay.querySelector('.case-name');
            caseName.textContent = data.name;
            
            // Clear existing items
            overlay.querySelectorAll('.items-grid').forEach(grid => grid.innerHTML = '');
            
            // Show/hide contraband section based on case type
            const contrabandRow = overlay.querySelector('.content-row.rarity-CONTRABAND');
            if (contrabandRow) {
                contrabandRow.style.display = caseType === 'huntsman' ? '' : 'none';
            }
            
            // Populate items by rarity
            for (const [grade, items] of Object.entries(data.skins)) {
                const rarity = grade.toUpperCase();
                const rarityRow = overlay.querySelector(`.content-row.rarity-${rarity}`);
                if (rarityRow) {
                    const grid = rarityRow.querySelector('.items-grid');
                    let itemsToShow = items;
                    
                    // Special handling for glove cases
                    if (grade === 'gold' && (caseType === 'hydra' || caseType === 'glove')) {
                        const gloveImages = [
                            'sportgloves_pandoras_box.png',
                            'specialistgloves_emerald_web.png',
                            'motogloves_spearmint.png',
                            'handwraps_slaughter.png',
                            'drivergloves_crimson_weave.png',
                            'bloodhoundgloves_charred.png'
                        ];
                        
                        const gloveNameMapping = {
                            'sportgloves': 'Sport Gloves',
                            'specialistgloves': 'Specialist Gloves',
                            'motogloves': 'Moto Gloves',
                            'handwraps': 'Hand Wraps',
                            'drivergloves': 'Driver Gloves',
                            'bloodhoundgloves': 'Bloodhound Gloves'
                        };
                        
                        itemsToShow = gloveImages.map(image => {
                            const gloveType = image.split('_')[0];
                            const skinName = image.split('_')
                                .slice(1)
                                .join(' ')
                                .replace('.png', '')
                                .split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                                
                            return {
                                weapon: gloveNameMapping[gloveType],
                                name: skinName,
                                image: image
                            };
                        });
                    }
                    // Special handling for Revolution Case gloves
                    else if (grade === 'gold' && (caseType === 'revolution' || caseType === 'clutch')) {
                        // Get one of each glove type
                        const gloveTypes = new Set();
                        const uniqueGloves = [];
                        
                        items.forEach(item => {
                            const gloveType = item.weapon;
                            if (!gloveTypes.has(gloveType)) {
                                gloveTypes.add(gloveType);
                                uniqueGloves.push(item);
                            }
                        });
                        
                        itemsToShow = uniqueGloves;
                    }
                    // For gold rarity in other cases (knives), filter based on case type
                    else if (grade === 'gold') {
                        if (caseType === 'chroma' || caseType === 'chroma_2' || caseType === 'chroma_3') {
                            itemsToShow = items.filter(item => item.name === 'Doppler');
                        } else if (caseType === 'gamma' || caseType === 'gamma_2') {
                            itemsToShow = items.filter(item => item.name === 'Gamma Doppler');
                        } else if (caseType === 'spectrum' || caseType === 'spectrum_2') {
                            itemsToShow = items.filter(item => item.name === 'Doppler');
                        } else {
                            itemsToShow = items.filter(item => item.name === 'Vanilla');
                        }
                    }
                    
                    // Add items to grid
                    itemsToShow.forEach(item => {
                        const div = createContentsItem(item, caseType);
                        grid.appendChild(div);
                    });
                }
            }
            
            // Show the overlay
            overlay.style.display = 'flex';
        }
    }

    // Add this helper function to create item elements
    function createContentsItem(item, caseType) {
        const div = document.createElement('div');
        div.className = 'contents-item';
        
        const casePath = CASE_MAPPING[caseType] || caseType;
        
        // Use the image name from the item data
        div.innerHTML = `
            <img src="/static/media/skins/${casePath}/${item.image}" 
                 alt="${item.weapon} | ${item.name}"
                 onerror="this.onerror=null; this.src='/static/media/cases/${casePath}.png'">
            <div class="item-name">${item.weapon}</div>
            <div class="item-skin">${item.name}</div>
        `;
        return div;
    }

    // Add this function to close the contents overlay
    function closeContentsOverlay() {
        const overlay = document.getElementById('case-contents-overlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // Get the overlay element
    const caseContentsOverlay = document.getElementById('case-contents-overlay');

    // Add click handler to the overlay
    if (caseContentsOverlay) {
        caseContentsOverlay.addEventListener('click', (e) => {
            if (e.target === caseContentsOverlay) {
                closeContentsOverlay();
            }
        });
    }

    async function loadFeaturedSkins() {
        try {
            console.log('Loading featured skins...');
            const response = await fetch('/get_featured_skins');
            const data = await response.json();
            
            if (data.error) {
                console.error('Error:', data.error);
                return null;
            }
            
            featuredSkins = data.skins;
            lastRefreshTime = data.refreshTime * 1000; // Convert to milliseconds
            localStorage.setItem('lastRefreshTime', lastRefreshTime.toString());
            return featuredSkins;
        } catch (error) {
            console.error('Error loading featured skins:', error);
            return null;
        }
    }

    function updateCountdown() {
        // Use lastRefreshTime directly instead of localStorage
        if (!lastRefreshTime) return;

        const countdown = document.querySelector('.countdown');
        if (!countdown) return;

        let updateInterval;

        function update() {
            const now = Date.now();
            const timeLeft = REFRESH_INTERVAL - (now - lastRefreshTime);

            if (timeLeft <= 0) {
                clearInterval(updateInterval);
                loadFeaturedSkins().then(updateFeaturedSkins);
                return;
            }

            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Clear any existing interval
        if (updateInterval) {
            clearInterval(updateInterval);
        }

        update(); // Initial update
        updateInterval = setInterval(update, 1000);
    }

    async function purchaseSkin(skin) {
        try {
            const response = await fetch('/buy_skin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(skin)
            });

            const data = await response.json();
            if (data.error) {
                showFloatingNotification(data.error);
                return;
            }

            // Update balance
            document.getElementById('balance').textContent = data.balance.toFixed(2);
            showFloatingNotification(`Purchased ${skin.weapon} | ${skin.name}!`);

        } catch (error) {
            console.error('Error:', error);
            showFloatingNotification('Failed to purchase skin');
        }
    }

    // Initialize featured skins when the page loads
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize the skins tab functionality
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', async () => {
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll('.shop-section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                const category = button.dataset.category;
                const section = document.getElementById(`${category}-section`);
                if (section) {
                    section.classList.remove('hidden');
                    if (category === 'skins') {
                        // Load skins when switching to skins tab
                        await loadFeaturedSkins();
                        updateFeaturedSkins();
                    }
                }
            });
        });

        // Initial load if we start on skins tab
        if (document.querySelector('[data-category="skins"]').classList.contains('active')) {
            await loadFeaturedSkins();
            updateFeaturedSkins();
        }
    });

    function updateFeaturedSkins() {
        console.log('Updating featured skins display...', 'Last refresh time:', new Date(lastRefreshTime));
        const skinsSection = document.getElementById('skins-section');
        if (!skinsSection || !featuredSkins) return;

        Object.entries(featuredSkins).forEach(([rarity, skin]) => {
            if (!skin) return;

            const card = skinsSection.querySelector(`.rarity-${rarity}`);
            if (!card) return;

            console.log(`Updating ${rarity} skin:`, skin);
            
            const imageContainer = card.querySelector('.skin-image');
            const casePath = skin.case_type === 'bravo' ? 'operation_bravo_case' : skin.case_file;
            const imgPath = `/static/media/skins/${casePath}/${skin.image}`;
            
            imageContainer.innerHTML = `
                <img src="${imgPath}" 
                     alt="${skin.weapon} | ${skin.name}"
                     onerror="this.onerror=null; this.src='/static/media/skins/weapon_case_1/ak47_case_hardened.png'">
            `;

            // Update info including float value
            card.querySelector('.skin-name').textContent = 
                `${skin.stattrak ? 'StatTrak™ ' : ''}${skin.weapon} | ${skin.name}`;
            card.querySelector('.skin-wear').textContent = skin.wear;
            card.querySelector('.skin-float').textContent = `Float: ${skin.float_value.toFixed(8)}`;
            card.querySelector('.skin-price').textContent = `$${skin.price.toFixed(2)}`;

            // Update button
            const buyButton = card.querySelector('.buy-skin-btn');
            buyButton.onclick = () => purchaseSkin(skin);
        });

        updateCountdown();
    }
</script>

{% endblock %} 