{% extends "base.html" %}

{% block title %}Inventory - Case Clicker{% endblock %}

{% block content %}
<h1>Your Inventory</h1>

<!-- Inventory categories -->
<div class="inventory-categories">
    <button class="category-btn active" data-category="skins">Skins</button>
    <button class="category-btn" data-category="cases">Cases</button>
</div>

<!-- Skins section -->
<div class="inventory-section" id="skins-section">
    <h2>Skins</h2>
    <div id="inventory-items" class="items-grid">
        {% set skin_index = namespace(value=0) %}
        {% for item in inventory %}
        {% if not item.is_case %}
        <div class="skin rarity-{{ item.rarity }}" data-index="{{ skin_index.value }}">
            <div class="skin-image">
                {% if not item.weapon.startswith('★') %}
                    {% set weapon_name = item.weapon.lower()
                        .replace('-', '')
                        .replace(' ', '')
                        .replace('galil ar', 'galil')
                        .replace('galilar', 'galil') %}
                    {% set skin_name = item.name.lower().replace(' ', '_') %}
                    {% set case_path = 'esports_2013' if item.case_type == 'esports' else 'weapon_case_1' %}
                    <img src="{{ url_for('static', filename='media/skins/' + case_path + '/' + weapon_name + '_' + skin_name + '.png') }}" 
                         alt="{{ item.weapon }} | {{ item.name }}">
                {% endif %}
            </div>
            <div class="item-name {{ 'stattrak' if item.stattrak else '' }}">
                {{ 'StatTrak™ ' if item.stattrak }}{{ item.weapon }}
            </div>
            <div class="item-skin">
                {{ item.name }} ({{ item.wear }})
            </div>
            <div class="item-price">${{ "{:.2f}".format(item.price) }}</div>
            <button class="btn sell-btn" data-sell-index="{{ skin_index.value }}">Sell</button>
        </div>
        {% set skin_index.value = skin_index.value + 1 %}
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Cases section -->
<div class="inventory-section hidden" id="cases-section">
    <h2>Cases</h2>
    <div class="items-grid">
        {% for item in inventory %}
            {% if item.is_case %}
            <div class="case-item">
                <img src="{{ url_for('static', filename='media/cases/' + item.image) }}" alt="{{ item.name }}">
                <div class="item-details">
                    <h3>{{ item.name }}</h3>
                    <p>Quantity: {{ item.quantity }}</p>
                    <button class="btn-small" onclick="openCase('{{ item.type }}')">Open Case</button>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Add the case opening overlay -->
<div id="case-opening-overlay" class="hidden">
    <audio id="spinning-sound" preload="auto">
        <source src="{{ url_for('static', filename='media/case_spinning.mp3') }}" type="audio/mpeg">
    </audio>
    <div class="spinner-container">
        <div class="spinner">
            <!-- Items will be inserted here dynamically -->
        </div>
        <div class="spinner-selector"></div>
    </div>
</div>

<!-- Add the showcase overlay -->
<div id="showcase-overlay" class="showcase-overlay" style="display: none;">
    <audio id="showcase-sound" preload="auto">
        <source src="{{ url_for('static', filename='media/case_showcase.mp3') }}" type="audio/mpeg">
    </audio>
    <div class="showcase-container">
        <div class="showcase-item">
            <div class="showcase-name"></div>
            <div class="showcase-details"></div>
            <div class="showcase-price"></div>
        </div>
        <div class="showcase-buttons">
            <button class="showcase-continue">Continue</button>
            <button class="showcase-sell">Sell</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set initial view based on server parameter
document.addEventListener('DOMContentLoaded', () => {
    const initialView = '{{ initial_view }}';
    if (initialView) {
        document.querySelector(`[data-category="${initialView}"]`).click();
    }
});

// Update the knives object to only include supported combinations
const knives = {
    "Karambit": [
        {
            name: "Urban Masked",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Blue Steel",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Stained",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Safari Mesh",
            wears: ["FT", "WW", "BS"]
        }
    ],
    "M9 Bayonet": [
        {
            name: "Safari Mesh",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Blue Steel",
            wears: ["FT", "WW", "BS"]
        }
    ],
    "Bayonet": [
        {
            name: "Blue Steel",
            wears: ["FT", "WW", "BS"]
        }
    ],
    "Flip Knife": [
        {
            name: "Safari Mesh",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Stained",
            wears: ["FT", "WW", "BS"]
        }
    ],
    "Gut Knife": [
        {
            name: "Safari Mesh",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Blue Steel",
            wears: ["FT", "WW", "BS"]
        },
        {
            name: "Stained",
            wears: ["FT", "WW", "BS"]
        }
    ]
};

const validWears = {
    "AWP|Lightning Strike": ["FN", "MW"],
    "AK-47|Case Hardened": ["FN", "MW", "FT", "WW", "BS"],
    "Desert Eagle|Hypnotic": ["FN", "MW"],
    "USP-S|Dark Water": ["MW", "FT"],
    "Glock-18|Dragon Tattoo": ["FN", "MW"],
    "M4A1-S|Dark Water": ["MW", "FT"],
    "AUG|Wings": ["FN", "MW"],
    "MP7|Skulls": ["MW", "FT"],
    "SG 553|Ultraviolet": ["FN", "MW", "FT", "WW", "BS"],
    "★ Flip Knife|Urban Masked": ["FN", "MW", "FT", "WW", "BS"],
    "★ Flip Knife|Safari Mesh": ["FN", "MW", "FT", "WW", "BS"],
    "★ Flip Knife|Stained": ["FN", "MW", "FT", "WW", "BS"],
    "★ Bayonet|Urban Masked": ["FN", "MW", "FT", "WW", "BS"],
    "★ Bayonet|Blue Steel": ["FN", "MW", "FT", "WW", "BS"],
    "★ Bayonet|Stained": ["FN", "MW", "FT", "WW", "BS"],
    "★ M9 Bayonet|Urban Masked": ["FN", "MW", "FT", "WW", "BS"],
    "★ M9 Bayonet|Safari Mesh": ["FN", "MW", "FT", "WW", "BS"],
    "★ M9 Bayonet|Stained": ["FN", "MW", "FT", "WW", "BS"],
    "★ M9 Bayonet|Blue Steel": ["FN", "MW", "FT", "WW", "BS"],
    "★ Karambit|Urban Masked": ["FN", "MW", "FT", "WW", "BS"],
    "★ Karambit|Blue Steel": ["FN", "MW", "FT", "WW", "BS"],
    "★ Karambit|Stained": ["FN", "MW", "FT", "WW", "BS"],
    "★ Karambit|Safari Mesh": ["FN", "MW", "FT", "WW", "BS"],
    "★ Gut Knife|Urban Masked": ["FN", "MW", "FT", "WW", "BS"],
    "★ Gut Knife|Safari Mesh": ["FN", "MW", "FT", "WW", "BS"],
    "★ Gut Knife|Stained": ["FN", "MW", "FT", "WW", "BS"],
    "★ Gut Knife|Blue Steel": ["FN", "MW", "FT", "WW", "BS"]
};

// Copy the entire skinPrices object from shop.html
const skinPrices = {
    // ... (copy the entire skinPrices object from shop.html)
};

// Add category switching functionality
document.querySelectorAll('.category-btn').forEach(button => {
    button.addEventListener('click', () => {
        // Remove active class from all buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Hide all sections
        document.querySelectorAll('.inventory-section').forEach(section => {
            section.classList.add('hidden');
        });
        
        // Show selected section
        const category = button.dataset.category;
        document.getElementById(`${category}-section`).classList.remove('hidden');
    });
});

// Update the sell button click handler in the DOMContentLoaded event
document.querySelectorAll('.sell-btn').forEach(button => {
    button.addEventListener('click', async function() {
        // Prevent double-clicking
        if (this.disabled) return;
        this.disabled = true;

        const itemElement = this.closest('.skin');
        if (!itemElement) {
            console.error('Could not find parent skin element');
            this.disabled = false;
            return;
        }
        
        const index = parseInt(itemElement.dataset.index);
        if (isNaN(index)) {
            console.error('Invalid index:', itemElement.dataset.index);
            this.disabled = false;
            return;
        }
        
        try {
            const response = await fetch(`/sell/${index}`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
                this.disabled = false;
                return;
            }
            
            // Update balance
            document.getElementById('balance').textContent = data.balance.toFixed(2);
            
            // Remove the sold item from display with animation
            itemElement.style.animation = 'fadeOut 0.3s';
            setTimeout(() => {
                itemElement.remove();
                
                // Update remaining items' indices
                document.querySelectorAll('.skin').forEach((skin, newIndex) => {
                    skin.dataset.index = newIndex;
                    // Update the sell button's data-sell-index
                    const sellBtn = skin.querySelector('.sell-btn');
                    if (sellBtn) {
                        sellBtn.dataset.sellIndex = newIndex;
                    }
                });
            }, 300);
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to sell item');
        } finally {
            this.disabled = false;
        }
    });
});

async function openCase(caseType) {
    try {
        // Update case quantity display immediately
        const caseElement = document.querySelector(`[onclick="openCase('${caseType}')"]`).closest('.case-item');
        const quantityElement = caseElement.querySelector('p');
        let currentQuantity = parseInt(quantityElement.textContent.split(': ')[1]);
        quantityElement.textContent = `Quantity: ${currentQuantity - 1}`;
        
        // If this was the last case, remove the case item
        if (currentQuantity - 1 === 0) {
            caseElement.remove();
        }

        const response = await fetch(`/open/${caseType}`);
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            // Restore the quantity if there was an error
            quantityElement.textContent = `Quantity: ${currentQuantity}`;
            return;
        }
        
        // Update balance
        document.getElementById('balance').textContent = data.balance.toFixed(2);
        
        // Show case opening animation
        const overlay = document.getElementById('case-opening-overlay');
        const spinner = document.querySelector('.spinner');
        const spinningSound = document.getElementById('spinning-sound');
        
        spinner.innerHTML = '';
        overlay.classList.remove('hidden');

        // Play the spinning sound
        spinningSound.currentTime = 0;
        spinningSound.play();

        // Generate random items with the actual item
        const { items, winningPosition } = generateRandomItems(data.item);
        
        // Create spinner items
        const elements = items.map((item, index) => {
            const element = createItemElement(item);
            if (index === winningPosition) {
                element.dataset.winning = 'true';
            }
            return element;
        });

        elements.forEach(element => spinner.appendChild(element));

        // Initial position
        spinner.style.transition = 'none';
        spinner.style.transform = 'translateX(0)';
        spinner.offsetHeight; // Force reflow
        
        const itemWidth = 200;
        const spinnerContainer = document.querySelector('.spinner-container');
        const containerWidth = spinnerContainer.offsetWidth;
        const centerOffset = (containerWidth / 2) - (itemWidth / 2);
        const randomOffset = Math.floor(Math.random() * itemWidth) - (itemWidth / 2);
        const finalPosition = (winningPosition * itemWidth) - centerOffset + randomOffset;
        
        // Spin animation
        spinner.style.transition = 'transform 6s cubic-bezier(0.12, 0.39, 0.01, 1)';
        spinner.style.transform = `translateX(-${finalPosition}px)`;
        
        // Hide overlay and show result
        setTimeout(() => {
            overlay.classList.add('hidden');
            spinningSound.pause();
            showItemShowcase(data.item);
        }, 6300);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to open case');
    }
}

async function sellItem(index) {
    try {
        const response = await fetch(`/sell/${index}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.error) {
            alert(data.error);
            return;
        }
        
        // Update balance
        document.getElementById('balance').textContent = data.balance.toFixed(2);
        
        // Remove the sold item from display
        const itemElement = document.querySelector(`[data-index="${index}"]`);
        itemElement.style.animation = 'fadeOut 0.3s';
        setTimeout(() => {
            itemElement.remove();
            
            // Update remaining items' indices
            document.querySelectorAll('.skin').forEach((skin, newIndex) => {
                skin.dataset.index = newIndex;
            });
        }, 300);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to sell item');
    }
}

function generateRandomItems(actualItem) {
    const itemPools = {
        BLUE: caseContents[actualItem.case_type].contents.BLUE,
        PURPLE: caseContents[actualItem.case_type].contents.PURPLE,
        PINK: caseContents[actualItem.case_type].contents.PINK,
        RED: caseContents[actualItem.case_type].contents.RED,
        GOLD: caseContents[actualItem.case_type].contents.GOLD
    };

    function randomFromPool(rarity) {
        const pool = itemPools[rarity];
        const item = {...pool[Math.floor(Math.random() * pool.length)]};
        const hasStattrak = Math.random() < 0.1;
        
        // Get valid wears and price from the correct case file
        const skinKey = `${item.weapon}|${item.name}`;
        const availableWears = validWears[skinKey] || ["FT"];
        const wear = availableWears[Math.floor(Math.random() * availableWears.length)];
        
        return {
            ...item,
            stattrak: hasStattrak,
            wear: wear,
            case_type: actualItem.case_type  // Include case_type in generated items
        };
    }

    function generateRandomItem() {
        // Roll for rarity
        const roll = Math.random() * 100;
        let chosenRarity;
        
        if (roll < 0.26) {  // 0.26% chance for Gold
            chosenRarity = "GOLD";
        } else if (roll < 0.26 + 0.90) {  // 0.90% chance for Red
            chosenRarity = "RED";
        } else if (roll < 0.26 + 0.90 + 4.10) {  // 4.10% chance for Pink
            chosenRarity = "PINK";
        } else if (roll < 0.26 + 0.90 + 4.10 + 20.08) {  // 20.08% chance for Purple
            chosenRarity = "PURPLE";
        } else {  // Remaining ~74.66% chance for Blue
            chosenRarity = "BLUE";
        }

        return randomFromPool(chosenRarity);
    }

    const items = [];
    const totalItems = 100;
    const winningPosition = 85;
    
    // Generate random items for the wheel
    for (let i = 0; i < totalItems; i++) {
        if (i === winningPosition) {
            // Place the actual item from the server exactly at the winning position
            items.push({
                weapon: actualItem.weapon,
                name: actualItem.name,
                rarity: actualItem.rarity,
                wear: actualItem.wear,
                stattrak: actualItem.stattrak,
                price: actualItem.price,
                case_type: actualItem.case_type
            });
        } else {
            // Generate a random item based on rarity percentages
            items.push(generateRandomItem());
        }
    }
    
    return { items, winningPosition };
}

function createItemElement(item) {
    const div = document.createElement('div');
    div.className = `spinner-item rarity-${item.rarity}`;
    div.classList.add(item.wear);
    
    div.dataset.item = JSON.stringify(item);
    
    // Create image container
    const imageContainer = document.createElement('div');
    imageContainer.className = 'spinner-item-image';
    
    if (item.rarity === 'GOLD') {
        // For gold items, always show "Rare Special Item"
        div.innerHTML = `
            <div class="spinner-item-image">
                <img src="/static/media/cases/rare_item.png" alt="Rare Special Item">
            </div>
            <div class="item-name">★</div>
            <div class="item-skin">Rare Special Item</div>
        `;
    } else {
        // For regular skins, add the image
        const weaponName = item.weapon.toLowerCase()
            .replace('-', '')
            .replace(' ', '')
            .replace('553', '553')
            .replace('galil ar', 'galil')
            .replace('galilar', 'galil');
        const skinName = item.name.toLowerCase()
            .replace(/ /g, '_');
        
        // Determine case path based on case type
        const casePath = item.case_type === 'esports' ? 'esports_2013' : 'weapon_case_1';
        
        const img = document.createElement('img');
        img.src = `/static/media/skins/${casePath}/${weaponName}_${skinName}.png`;
        img.alt = `${item.weapon} | ${item.name}`;
        
        imageContainer.appendChild(img);
        div.appendChild(imageContainer);
        
        div.innerHTML += `
            <div class="item-name ${item.stattrak ? 'stattrak' : ''}">
                ${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon}
            </div>
            <div class="item-skin">
                ${item.name} (${item.wear})
            </div>
        `;
    }
    return div;
}

function showItemShowcase(item) {
    const showcase = document.getElementById('showcase-overlay');
    const showcaseSound = document.getElementById('showcase-sound');
    const showcaseContainer = showcase.querySelector('.showcase-container');
    
    // Clear any existing buttons container
    const existingButtons = showcaseContainer.querySelector('.showcase-buttons');
    if (existingButtons) {
        existingButtons.remove();
    }
    
    // Create and set up all elements first
    const nameElement = document.createElement('div');
    nameElement.className = `showcase-name ${item.stattrak ? 'stattrak' : ''}`;
    
    const detailsElement = document.createElement('div');
    detailsElement.className = 'showcase-details';
    
    const priceElement = document.createElement('div');
    priceElement.className = 'showcase-price';
    
    // Create image element
    const imageElement = document.createElement('img');
    const casePath = item.case_type === 'esports' ? 'esports_2013' : 'weapon_case_1';
    
    if (item.rarity === 'GOLD') {
        const weaponName = item.weapon.replace('★ ', '').toLowerCase().replace(' ', '');
        const skinName = item.name.toLowerCase().replace(' ', '_');
        imageElement.src = `/static/media/skins/${casePath}/${weaponName}_${skinName}.png`;
    } else {
        const weaponName = item.weapon.toLowerCase()
            .replace('-', '')
            .replace(' ', '')
            .replace('553', '553')
            .replace('galil ar', 'galil')
            .replace('galilar', 'galil');
        const skinName = item.name.toLowerCase().replace(/ /g, '_');
        imageElement.src = `/static/media/skins/${casePath}/${weaponName}_${skinName}.png`;
    }
    
    imageElement.style.maxWidth = '300px';
    imageElement.style.marginBottom = '1rem';
    
    // Update showcase content
    const itemContainer = showcase.querySelector('.showcase-item');
    itemContainer.innerHTML = ''; // Clear existing content
    
    // Add all elements to the container
    itemContainer.appendChild(imageElement);
    itemContainer.appendChild(nameElement);
    itemContainer.appendChild(detailsElement);
    itemContainer.appendChild(priceElement);
    
    // Remove any existing rarity classes from container
    showcaseContainer.className = 'showcase-container';
    showcaseContainer.classList.add(`rarity-${item.rarity}`);
    
    // Set text content
    nameElement.textContent = `${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon} | ${item.name}`;
    detailsElement.textContent = `${item.wear} • ${item.rarity === 'GOLD' ? 'Rare Special Item' : item.rarity}`;
    
    // Fetch price from the correct case file
    fetch(`/data/case_contents/${item.case_type}`)
        .then(response => response.json())
        .then(caseData => {
            let price = 0;
            for (const [grade, skins] of Object.entries(caseData.skins)) {
                for (const skin of skins) {
                    if (skin.weapon === item.weapon && skin.name === item.name) {
                        const prices = skin.prices;
                        const wearKey = 'NO' in prices ? 'NO' : item.wear;
                        price = item.stattrak ? 
                            (prices[`ST_${wearKey}`] || 0) : 
                            (prices[wearKey] || 0);
                        break;
                    }
                }
                if (price > 0) break;
            }
            
            // Update the showcase with the correct price
            priceElement.textContent = `$${price.toFixed(2)}`;
            
            // Update the item object with the correct price
            item.price = price;
        })
        .catch(error => {
            console.error('Error fetching case data:', error);
            priceElement.textContent = '$0.00';
        });
    
    // Create buttons container and buttons
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'showcase-buttons';
    
    const continueButton = document.createElement('button');
    continueButton.className = 'showcase-continue';
    continueButton.textContent = 'Continue';
    
    const sellButton = document.createElement('button');
    sellButton.className = 'showcase-sell';
    sellButton.textContent = 'Sell';
    
    buttonsContainer.appendChild(continueButton);
    buttonsContainer.appendChild(sellButton);
    showcaseContainer.appendChild(buttonsContainer);
    
    // Add button handlers
    continueButton.onclick = async () => {
        showcase.style.display = 'none';
        showcaseSound.pause();
        await updateInventoryDisplay();
    };
    
    sellButton.onclick = async () => {
        try {
            const response = await fetch('/sell/last', { method: 'POST' });
            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Update balance
            document.getElementById('balance').textContent = data.balance.toFixed(2);
            
            // Close showcase
            showcase.style.display = 'none';
            showcaseSound.pause();
            
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to sell item');
        }
    };
    
    // Show overlay and play sound
    showcase.style.display = 'flex';
    showcaseSound.currentTime = 0;
    showcaseSound.play();
}

// Update the DOMContentLoaded event handler
document.addEventListener('DOMContentLoaded', () => {
    // Check if there's a new item to add
    const newItemJson = sessionStorage.getItem('newItem');
    if (newItemJson) {
        const item = JSON.parse(newItemJson);
        const inventoryItems = document.getElementById('inventory-items');
        const newIndex = inventoryItems.children.length;
        
        const skinDiv = document.createElement('div');
        skinDiv.className = `skin rarity-${item.rarity}`;
        skinDiv.dataset.index = newIndex;
        
        // Create weapon image
        const weaponName = item.weapon.toLowerCase()
            .replace('-', '')
            .replace(' ', '')
            .replace('553', '553');
        const skinName = item.name.toLowerCase().replace(' ', '_');
        
        skinDiv.innerHTML = `
            <div class="skin-image">
                ${!item.weapon.startsWith('★') ? `
                    <img src="/static/media/skins/weapon_case_1/${weaponName}_${skinName}.png" 
                         alt="${item.weapon} | ${item.name}">
                ` : ''}
            </div>
            <div class="item-name ${item.stattrak ? 'stattrak' : ''}">
                ${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon}
            </div>
            <div class="item-skin">
                ${item.name} (${item.wear})
            </div>
            <div class="item-price">$${item.price.toFixed(2)}</div>
            <button class="btn sell-btn" data-sell-index="${newIndex}">Sell</button>
        `;
        
        // Add sell button handler
        const sellBtn = skinDiv.querySelector('.sell-btn');
        if (sellBtn) {
            sellBtn.addEventListener('click', async function() {
                const itemElement = this.closest('.skin');
                if (!itemElement) return;
                const index = parseInt(itemElement.dataset.index);
                try {
                    const response = await fetch(`/sell/${index}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    // Update balance
                    document.getElementById('balance').textContent = data.balance.toFixed(2);
                    
                    // Remove the sold item
                    itemElement.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => {
                        itemElement.remove();
                        
                        // Update remaining indices
                        document.querySelectorAll('.skin').forEach((skin, newIndex) => {
                            skin.dataset.index = newIndex;
                        });
                    }, 300);
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to sell item');
                }
            });
        }
        
        inventoryItems.appendChild(skinDiv);
        
        // Clear the stored item
        sessionStorage.removeItem('newItem');
    }
    
    // Add click handlers to all existing sell buttons
    document.querySelectorAll('.sell-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const itemElement = this.closest('.skin');
            if (!itemElement) {
                console.error('Could not find parent skin element');
                return;
            }
            
            const index = parseInt(itemElement.dataset.index);
            if (isNaN(index)) {
                console.error('Invalid index:', itemElement.dataset.index);
                return;
            }
            
            try {
                const response = await fetch(`/sell/${index}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Update balance
                document.getElementById('balance').textContent = data.balance.toFixed(2);
                
                // Remove the sold item from display with animation
                itemElement.style.animation = 'fadeOut 0.3s';
                setTimeout(() => {
                    itemElement.remove();
                    
                    // Update remaining items' indices
                    document.querySelectorAll('.skin').forEach((skin, newIndex) => {
                        skin.dataset.index = newIndex;
                    });
                }, 300);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to sell item');
            }
        });
    });
});

// Update the updateInventoryDisplay function
async function updateInventoryDisplay() {
    try {
        const response = await fetch('/get_inventory');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }
        
        const inventoryItems = document.getElementById('inventory-items');
        if (!inventoryItems) {
            console.error('Could not find inventory-items element');
            return;
        }
        
        // Clear current inventory
        inventoryItems.innerHTML = '';
        
        // Add each item
        let skinIndex = 0;
        for (const item of data.inventory) {
            if (!item.is_case) {
                // Fetch price from the correct case file
                try {
                    const caseResponse = await fetch(`/data/case_contents/${item.case_type}`);
                    const caseData = await caseResponse.json();
                    
                    // Find the item's price in the case data
                    let price = 0;
                    for (const [grade, skins] of Object.entries(caseData.skins)) {
                        for (const skin of skins) {
                            if (skin.weapon === item.weapon && skin.name === item.name) {
                                const prices = skin.prices;
                                const wearKey = 'NO' in prices ? 'NO' : item.wear;
                                price = item.stattrak ? 
                                    (prices[`ST_${wearKey}`] || 0) : 
                                    (prices[wearKey] || 0);
                                break;
                            }
                        }
                        if (price > 0) break;
                    }
                    
                    // Update the item's price
                    item.price = price;
                } catch (error) {
                    console.error('Error fetching case data:', error);
                    item.price = 0;
                }
                
                const skinDiv = document.createElement('div');
                skinDiv.className = `skin rarity-${item.rarity}`;
                skinDiv.dataset.index = skinIndex;
                
                const weaponName = item.weapon.toLowerCase()
                    .replace('-', '')
                    .replace(' ', '')
                    .replace('553', '553')
                    .replace('galil ar', 'galil')
                    .replace('galilar', 'galil');
                const skinName = item.name.toLowerCase().replace(/ /g, '_');
                const casePath = item.case_type === 'esports' ? 'esports_2013' : 'weapon_case_1';
                
                skinDiv.innerHTML = `
                    <div class="skin-image">
                        ${!item.weapon.startsWith('★') ? `
                            <img src="/static/media/skins/${casePath}/${weaponName}_${skinName}.png" 
                                 alt="${item.weapon} | ${item.name}">
                        ` : ''}
                    </div>
                    <div class="item-name ${item.stattrak ? 'stattrak' : ''}">
                        ${item.stattrak ? 'StatTrak™ ' : ''}${item.weapon}
                    </div>
                    <div class="item-skin">
                        ${item.name} (${item.wear})
                    </div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                    <button class="btn sell-btn" data-sell-index="${skinIndex}">Sell</button>
                `;
                
                // Add sell button handler
                const sellBtn = skinDiv.querySelector('.sell-btn');
                if (sellBtn) {
                    sellBtn.addEventListener('click', async function() {
                        await sellItem(skinIndex);
                    });
                }
                
                inventoryItems.appendChild(skinDiv);
                skinIndex++;
            }
        }
        
    } catch (error) {
        console.error('Error updating inventory:', error);
    }
}

// Add this after the knives object and before generateRandomItems function
const caseContents = {
    'csgo': {
        name: "CS:GO Weapon Case",
        contents: {
            GOLD: [
                { weapon: "★ Karambit", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Karambit", name: "Blue Steel", rarity: "GOLD" },
                { weapon: "★ Karambit", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Karambit", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Stained", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Blue Steel", rarity: "GOLD" },
                { weapon: "★ Bayonet", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Bayonet", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Bayonet", name: "Blue Steel", rarity: "GOLD" },
                { weapon: "★ Flip Knife", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Flip Knife", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ Flip Knife", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Blue Steel", rarity: "GOLD" }
            ],
            RED: [
                { weapon: "AWP", name: "Lightning Strike", rarity: "RED" }
            ],
            PINK: [
                { weapon: "AK-47", name: "Case Hardened", rarity: "PINK" },
                { weapon: "Desert Eagle", name: "Hypnotic", rarity: "PINK" }
            ],
            PURPLE: [
                { weapon: "Glock-18", name: "Dragon Tattoo", rarity: "PURPLE" },
                { weapon: "M4A1-S", name: "Dark Water", rarity: "PURPLE" },
                { weapon: "USP-S", name: "Dark Water", rarity: "PURPLE" }
            ],
            BLUE: [
                { weapon: "SG 553", name: "Ultraviolet", rarity: "BLUE" },
                { weapon: "MP7", name: "Skulls", rarity: "BLUE" },
                { weapon: "AUG", name: "Wings", rarity: "BLUE" }
            ]
        }
    },
    'esports': {
        name: "eSports 2013 Case",
        contents: {
            GOLD: [
                { weapon: "★ Karambit", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Karambit", name: "Blue Steel", rarity: "GOLD" },
                { weapon: "★ Karambit", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Karambit", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Stained", rarity: "GOLD" },
                { weapon: "★ M9 Bayonet", name: "Blue Steel", rarity: "GOLD" },
                { weapon: "★ Bayonet", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Bayonet", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Bayonet", name: "Blue Steel", rarity: "GOLD" },
                { weapon: "★ Flip Knife", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Flip Knife", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ Flip Knife", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Urban Masked", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Safari Mesh", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Stained", rarity: "GOLD" },
                { weapon: "★ Gut Knife", name: "Blue Steel", rarity: "GOLD" }
            ],
            RED: [
                { weapon: "P90", name: "Death by Kitty", rarity: "RED" }
            ],
            PINK: [
                { weapon: "AWP", name: "BOOM", rarity: "PINK" },
                { weapon: "AK-47", name: "Red Laminate", rarity: "PINK" }
            ],
            PURPLE: [
                { weapon: "Galil AR", name: "Orange DDPAT", rarity: "PURPLE" },
                { weapon: "P250", name: "Splash", rarity: "PURPLE" },
                { weapon: "Sawed-Off", name: "Orange DDPAT", rarity: "PURPLE" }
            ],
            BLUE: [
                { weapon: "M4A4", name: "Faded Zebra", rarity: "BLUE" },
                { weapon: "MAG-7", name: "Memento", rarity: "BLUE" },
                { weapon: "FAMAS", name: "Doomkitty", rarity: "BLUE" }
            ]
        }
    }
};
</script>
{% endblock %} 